<div class="loan-request-page">
  <div class="container">
    <div class="loan-request-container">
      <!-- Header refinado -->
      <div class="request-header">
        <h1>Solicitar Pr√©stamo</h1>
        <p class="request-subtitle">Completa el formulario para solicitar un pr√©stamo descentralizado</p>
      </div>
      
      <!-- Conexi√≥n de wallet -->
      <div class="card" *ngIf="!account">
        <div class="card-header">
          <h3 class="card-title">üîó Conectar Wallet</h3>
        </div>
        <div class="card-body">
          <p class="connection-text">Para solicitar un pr√©stamo, necesitas conectar tu wallet de Ethereum.</p>
          <div class="connection-info">
            <div class="info-item">
              <span class="info-icon">üõ°Ô∏è</span>
              <span class="info-text">100% Seguro</span>
            </div>
            <div class="info-item">
              <span class="info-icon">‚ö°</span>
              <span class="info-text">Transacciones R√°pidas</span>
            </div>
            <div class="info-item">
              <span class="info-icon">üîí</span>
              <span class="info-text">Privacidad Total</span>
            </div>
          </div>
          <button 
            class="btn btn-primary" 
            (click)="connect()" 
            [disabled]="isLoading">
            <span class="btn-icon" *ngIf="!isLoading">üîó</span>
            <span class="btn-icon" *ngIf="isLoading">‚è≥</span>
            <span class="btn-text">{{ isLoading ? 'Conectando...' : 'Conectar con MetaMask' }}</span>
          </button>
          <div class="alert alert-danger" *ngIf="error">
            <span class="alert-icon">‚ö†Ô∏è</span>
            {{ error }}
          </div>
        </div>
      </div>
      
      <!-- Informaci√≥n de cuenta conectada -->
      <div class="card" *ngIf="account">
        <div class="card-header">
          <h3 class="card-title">‚úÖ Wallet Conectada</h3>
        </div>
        <div class="card-body">
          <div class="account-details">
            <div class="detail-item">
              <span class="detail-label">Direcci√≥n:</span>
              <span class="detail-value">{{ account | slice:0:10 }}...{{ account | slice:-4 }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Red:</span>
              <span class="detail-value">{{ chainId }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Estado:</span>
              <span class="status-badge status-connected">Conectado</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Formulario de solicitud -->
      <form *ngIf="account" (ngSubmit)="submitLoanRequest()">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">üìù Informaci√≥n Personal</h3>
          </div>
          <div class="card-body">
            <!-- Nombre del solicitante -->
            <div class="form-group">
              <label for="borrowerName">Nombre Completo *</label>
              <input 
                type="text" 
                id="borrowerName" 
                class="form-control" 
                [(ngModel)]="loanForm.borrowerName" 
                name="borrowerName"
                placeholder="Ingresa tu nombre completo"
                required>
            </div>
            
            <!-- Monto del pr√©stamo -->
            <div class="form-group">
              <label for="amount">Monto del Pr√©stamo (ETH) *</label>
              <div class="amount-container">
                <input 
                  type="number" 
                  id="amount" 
                  class="form-control amount-input" 
                  [(ngModel)]="loanForm.amount" 
                  name="amount"
                  placeholder="0.00"
                  step="0.01"
                  min="0.01"
                  [max]="loanLimit"
                  (input)="onAmountChange()"
                  required>
                <div class="amount-limit">
                  <span class="limit-text">L√≠mite: {{ loanLimit }} ETH</span>
                </div>
              </div>
            </div>
            
            <!-- Tipo de prop√≥sito -->
            <div class="form-group">
              <label>Tipo de Prop√≥sito *</label>
              <div class="purpose-grid">
                <div 
                  *ngFor="let purposeType of purposeTypes" 
                  class="purpose-card"
                  [class.selected]="loanForm.purposeType === purposeType.value"
                  [class.verified]="purposeType.value === 'student' && isStudentVerified"
                  (click)="updatePurposeTypeWithType(purposeType)">
                  <div class="purpose-icon">
                    <span *ngIf="purposeType.value === 'student'">üéì</span>
                    <span *ngIf="purposeType.value === 'business'">üíº</span>
                    <span *ngIf="purposeType.value === 'health'">‚ù§Ô∏è</span>
                    <span *ngIf="purposeType.value === 'events'">üéâ</span>
                    <span *ngIf="purposeType.value === 'other'">üîß</span>
                  </div>
                  <div class="purpose-content">
                    <div class="purpose-title">{{ purposeType.label }}</div>
                    <div class="purpose-rate">{{ (purposeType.interestRate * 100).toFixed(0) }}% inter√©s</div>
                    <div class="verification-badge" *ngIf="purposeType.value === 'student' && isStudentVerified">
                      ‚úì Verificado
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Mensaje de verificaci√≥n de estudiante -->
            <div class="verification-status" *ngIf="loanForm.purposeType === 'student'">
              <div class="verification-box verified" *ngIf="isStudentVerified">
                <div class="verification-icon">‚úÖ</div>
                <div class="verification-info">
                  <h4>Estudiante Verificado</h4>
                  <p>{{ studentVerificationData?.firstName }} {{ studentVerificationData?.lastName }}</p>
                  <p class="small-text">{{ studentVerificationData?.email }}</p>
                  <p class="small-text">{{ studentVerificationData?.universityName }} - {{ studentVerificationData?.careerProgram }}</p>
                </div>
              </div>
              <div class="verification-box not-verified" *ngIf="!isStudentVerified">
                <div class="verification-icon">‚ö†Ô∏è</div>
                <div class="verification-info">
                  <h4>Verificaci√≥n Requerida</h4>
                  <p>Para acceder a la tasa de estudiante (12%), debes verificar tu condici√≥n.</p>
                  <button 
                    type="button" 
                    class="btn btn-verify" 
                    (click)="openStudentVerification()">
                    üéì Verificar Ahora
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Prop√≥sito detallado -->
            <div class="form-group">
              <label for="purpose">¬øPor qu√© pides el pr√©stamo? *</label>
              <textarea 
                id="purpose" 
                class="form-control" 
                [(ngModel)]="loanForm.purpose" 
                name="purpose"
                placeholder="Describe detalladamente para qu√© necesitas el pr√©stamo..."
                rows="4"
                required></textarea>
            </div>
            
            <!-- Duraci√≥n del pr√©stamo -->
            <div class="form-group">
              <label>Duraci√≥n del Pr√©stamo *</label>
              <div class="duration-grid">
                <div 
                  *ngFor="let duration of loanDurations" 
                  class="duration-card"
                  [class.selected]="loanForm.loanDuration === duration.value"
                  [class.has-discount]="duration.value === 7 || duration.value === 15"
                  [class.recommended]="duration.value === 30"
                  (click)="loanForm.loanDuration = duration.value; onDurationChange()">
                  <span class="duration-value">{{ duration.label }}</span>
                  <span class="duration-label discount" *ngIf="duration.value === 7">-2.5% descuento</span>
                  <span class="duration-label discount" *ngIf="duration.value === 15">-3% descuento</span>
                  <span class="duration-label normal" *ngIf="duration.value !== 7 && duration.value !== 15">Tasa normal</span>
                </div>
              </div>
              <div class="discount-info" *ngIf="hasDiscount">
                <span class="info-icon">üí∞</span>
                <span class="info-text">¬°Descuento del {{ discountPercentage }}% aplicado por pago r√°pido!</span>
              </div>
            </div>
            
            <!-- Red de blockchain -->
            <div class="form-group">
              <label>Red de Blockchain *</label>
              <div class="network-grid">
                <div 
                  *ngFor="let network of networks" 
                  class="network-card"
                  [class.selected]="loanForm.network === network.value"
                  (click)="updateNetworkWithConfig(network)">
                  <div class="network-icon">‚õìÔ∏è</div>
                  <div class="network-content">
                    <div class="network-name">{{ network.name }}</div>
                    <div class="network-limit">L√≠mite: {{ network.limit }} ETH</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Resumen del pr√©stamo -->
        <div class="card summary-card">
          <div class="card-header">
            <h3 class="card-title">üìä Resumen del Pr√©stamo</h3>
          </div>
          <div class="card-body">
            <div class="summary-grid">
              <div class="summary-item">
                <span class="summary-label">Monto Solicitado:</span>
                <span class="summary-value">{{ loanForm.amount || 0 }} ETH</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">Tasa de Inter√©s Base:</span>
                <span class="summary-value" [class.strikethrough]="hasDiscount">{{ (interestRate * 100).toFixed(1) }}%</span>
              </div>
              <div class="summary-item" *ngIf="hasDiscount">
                <span class="summary-label">Tasa con Descuento:</span>
                <span class="summary-value text-success">{{ (finalInterestRate * 100).toFixed(1) }}% (-{{ discountPercentage }}%)</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">Monto Total a Pagar:</span>
                <span class="summary-value text-accent">{{ totalAmount.toFixed(4) }} ETH</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">Duraci√≥n:</span>
                <span class="summary-value">{{ loanForm.loanDuration }} d√≠as</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Bot√≥n de env√≠o -->
        <div class="submit-section">
          <button 
            type="submit" 
            class="btn btn-success btn-large"
            [disabled]="!loanForm.borrowerName || !loanForm.amount || !loanForm.purpose">
            <span class="btn-icon">üöÄ</span>
            <span class="btn-text">Enviar Solicitud</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>