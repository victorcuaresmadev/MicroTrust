<div class="admin-container">
  <!-- Header con estadÃ­sticas y acciones -->
  <div class="admin-header">
    <div class="header-content">
      <h1>Panel de AdministraciÃ³n</h1>
      <p>Gestiona las solicitudes de prÃ©stamo y contratos</p>
    </div>
    
    <!-- EstadÃ­sticas -->
    <div class="stats-container">
      <div class="stat-card pending">
        <div class="stat-value">{{ pendingCount }}</div>
        <div class="stat-label">Pendientes</div>
      </div>
      <div class="stat-card approved">
        <div class="stat-value">{{ approvedCount }}</div>
        <div class="stat-label">Aprobados</div>
      </div>
      <div class="stat-card rejected">
        <div class="stat-value">{{ rejectedCount }}</div>
        <div class="stat-label">Rechazados</div>
      </div>
      <div class="stat-card paid">
        <div class="stat-value">{{ paidCount }}</div>
        <div class="stat-label">Pagados</div>
      </div>
    </div>
    
    <!-- Botones de acciÃ³n -->
    <div class="header-actions">
      <button 
        (click)="refreshLoans()" 
        class="btn btn-refresh">
        <span class="btn-icon">ğŸ”„</span>
        Actualizar
      </button>
      
      <button 
        (click)="clearCache()" 
        class="btn btn-warning">
        <span class="btn-icon">ğŸ§¹</span>
        Limpiar CachÃ©
      </button>
      
      <button 
        (click)="toggleTransactions()" 
        class="btn btn-info">
        <span class="btn-icon">ğŸ‘ï¸</span>
        {{ showTransactions ? 'Ocultar Transacciones' : 'Ver Transacciones' }}
      </button>
      

    </div>
  </div>
  
  <!-- Selector de vista de transacciones -->
  <div *ngIf="showTransactions" class="transaction-view-selector">
    <div class="view-toggle">
      <button 
        (click)="setTransactionView('admin')" 
        class="btn btn-toggle"
        [class.active]="transactionView === 'admin'">
        Transacciones Admin
      </button>
      <button 
        (click)="setTransactionView('client')" 
        class="btn btn-toggle"
        [class.active]="transactionView === 'client'">
        Transacciones Cliente
      </button>
    </div>
    
    <!-- Vista de transacciones -->
    <div class="transactions-container">
      <div *ngIf="transactionView === 'admin'" class="transaction-list">
        <h3>Transacciones como Administrador</h3>
        <p>Lista de transacciones realizadas por el administrador (aprobaciones, rechazos, etc.)</p>
        <div class="transaction-item" *ngFor="let loan of approvedLoans">
          <div class="transaction-details">
            <span class="transaction-icon">âœ…</span>
            <div class="transaction-info">
              <div class="transaction-title">PrÃ©stamo aprobado #{{ loan.id | slice:0:8 }}...</div>
              <div class="transaction-amount">{{ loan.amount }} ETH</div>
              <div class="transaction-date">{{ loan.approvedAt | date:'short' }}</div>
            </div>
          </div>
        </div>
        <div class="no-transactions" *ngIf="approvedLoans.length === 0">
          <p>No hay transacciones de aprobaciÃ³n registradas</p>
        </div>
      </div>
      
      <div *ngIf="transactionView === 'client'" class="transaction-list">
        <h3>Transacciones como Cliente</h3>
        <p>Lista de prÃ©stamos solicitados por clientes</p>
        <div class="transaction-item" *ngFor="let loan of allLoans">
          <div class="transaction-details">
            <span class="transaction-icon">ğŸ“‹</span>
            <div class="transaction-info">
              <div class="transaction-title">Solicitud de prÃ©stamo #{{ loan.id | slice:0:8 }}...</div>
              <div class="transaction-amount">{{ loan.amount }} ETH</div>
              <div class="transaction-date">{{ loan.createdAt | date:'short' }}</div>
              <div class="transaction-status" [ngClass]="'status-' + loan.status">
                {{ getStatusLabel(loan.status) }}
              </div>
            </div>
          </div>
        </div>
        <div class="no-transactions" *ngIf="allLoans.length === 0">
          <p>No hay solicitudes de prÃ©stamo registradas</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Selector de red -->
  <div class="network-selector">
    <h3>Cambiar Red</h3>
    <div class="network-buttons">
      <button 
        class="btn btn-network"
        (click)="switchNetwork('holesky')">
        HoleÅ¡ky
      </button>
      <button 
        class="btn btn-network"
        (click)="switchNetwork('sepolia')">
        Sepolia
      </button>
      <button 
        class="btn btn-network"
        (click)="openHoodiExplorer()"
        title="Agregar Hoodi manualmente desde el explorador">
        Hoodi âš ï¸
      </button>
      <button 
        class="btn btn-network"
        (click)="switchNetwork('goerli')">
        Goerli
      </button>
    </div>
  </div>
  
  <!-- Filtros -->
  <div class="filters-container">
    <div class="filter-group">
      <label for="statusFilter">Filtrar por estado:</label>
      <select 
        id="statusFilter" 
        [(ngModel)]="filterStatus" 
        (change)="applyFilter()" 
        class="form-control">
        <option value="all">Todos los estados</option>
        <option value="pending">Pendientes</option>
        <option value="approved">Aprobados</option>
        <option value="rejected">Rechazados</option>
        <option value="paid">Pagados</option>
        <option value="payment_pending">Pago Pendiente</option>
      </select>
    </div>
    
    <div class="filter-group">
      <label for="searchInput">Buscar:</label>
      <input 
        type="text" 
        id="searchInput" 
        [(ngModel)]="searchTerm" 
        (input)="applyFilter()" 
        placeholder="ID, nombre, direcciÃ³n..." 
        class="form-control">
    </div>
  </div>
  
  <!-- Mensaje de error -->
  <div *ngIf="error" class="alert alert-danger">
    <span class="alert-icon">âš ï¸</span>
    {{ error }}
  </div>
  
  <!-- Pantalla de carga -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="loading-spinner"></div>
    <p>Cargando prÃ©stamos...</p>
  </div>
  
  <!-- Lista de prÃ©stamos -->
  <div *ngIf="!isLoading && filteredLoans.length > 0" class="loans-container">
    <div class="loans-grid">
      <div 
        *ngFor="let loan of filteredLoans" 
        class="loan-card"
        [class.selected]="selectedLoan?.id === loan.id">
        <div class="loan-header">
          <div class="loan-info">
            <div class="loan-id">ID: {{ loan.id }}</div>
            <div class="loan-status" [ngClass]="'status-' + loan.status">
              {{ getStatusLabel(loan.status) }}
            </div>
          </div>
          <div class="loan-meta">
            <div class="loan-amount">
              <div style="font-size: 0.85em; color: #888;">ğŸ’° Monto:</div>
              <div>{{ loan.amount }} ETH</div>
              <div style="font-size: 0.75em; color: #059669;">ğŸ”´ Devolver: {{ loan.totalAmountToPay.toFixed(4) }} ETH</div>
            </div>
            <div class="loan-interest">{{ (loan.interestRate * 100).toFixed(1) }}%</div>
          </div>
        </div>
        
        <div class="loan-details">
          <div class="detail-row">
            <span class="label">Solicitante:</span>
            <span class="value">{{ loan.borrowerName }}</span>
          </div>
          
          <div class="detail-row">
            <span class="label">DirecciÃ³n:</span>
            <span class="value wallet-address">{{ loan.borrowerAddress | slice:0:10 }}...{{ loan.borrowerAddress | slice:-4 }}</span>
          </div>
          
          <div class="detail-row">
            <span class="label">PropÃ³sito:</span>
            <span class="value">{{ getPurposeTypeLabel(loan.purposeType) }}</span>
          </div>
          
          <div class="detail-row">
            <span class="label">Red:</span>
            <span class="value">{{ getNetworkLabel(loan.network) }}</span>
          </div>
          
          <div class="detail-row">
            <span class="label">Fecha:</span>
            <span class="value">{{ loan.createdAt | date:'short' }}</span>
          </div>
        </div>
        
        <!-- Botones de acciÃ³n -->
        <div class="loan-actions">
          <!-- Botones para prÃ©stamos pendientes -->
          <div *ngIf="loan.status === 'pending'" class="action-buttons">
            <button 
              (click)="approveLoan(loan)" 
              class="btn btn-success"
              [disabled]="isApproving">
              <span *ngIf="!isApproving">âœ… Aprobar</span>
              <span *ngIf="isApproving">Procesando...</span>
            </button>
            <button 
              (click)="showRejectConfirmation(loan)" 
              class="btn btn-danger">
              âŒ Rechazar
            </button>
            <button 
              (click)="viewLoanDetails(loan)" 
              class="btn btn-info">
              ğŸ‘ï¸ Ver Detalles
            </button>
            <button 
              (click)="openTransactionViewer(loan)" 
              class="btn btn-transaction"
              title="Ver transacciones en {{ getNetworkLabel(loan.network) }}">
              ğŸ” Transacciones
            </button>
          </div>
          
          <!-- Botones para prÃ©stamos aprobados -->
          <div *ngIf="loan.status === 'approved'" class="action-buttons">
            <button 
              (click)="generateAndPrintContract(loan)"
              class="btn btn-primary"
              title="Generar contrato e imprimir">
              ğŸ–¨ï¸ Imprimir Contrato
            </button>
            <button 
              (click)="downloadContract(loan)"
              class="btn btn-secondary"
              title="Descargar contrato como HTML">
              ğŸ’¾ Descargar
            </button>
            <button 
              (click)="viewContract(loan)"
              class="btn btn-info"
              title="Ver contrato en nueva pestaÃ±a">
              ğŸ‘ï¸ Ver Contrato
            </button>
            <button 
              (click)="viewLoanDetails(loan)" 
              class="btn btn-info">
              ğŸ“‹ Ver Detalles
            </button>
            <button 
              (click)="openTransactionViewer(loan)" 
              class="btn btn-transaction"
              title="Ver transacciones en {{ getNetworkLabel(loan.network) }}">
              ğŸ” Transacciones
            </button>
          </div>
          
          <!-- Mensajes para otros estados -->
          <div *ngIf="loan.status === 'rejected'" class="status-message rejected">
            PrÃ©stamo rechazado
          </div>
          
          <div *ngIf="loan.status === 'paid'" class="status-message paid">
            âœ… PrÃ©stamo pagado
          </div>
          
          <div *ngIf="loan.status === 'payment_pending'" class="status-message pending">
            â³ Pago pendiente
          </div>
          
          <!-- BotÃ³n de verificaciÃ³n para todos los prÃ©stamos -->
          <div *ngIf="!['pending', 'approved'].includes(loan.status)" class="action-buttons">
            <button 
              (click)="viewLoanDetails(loan)" 
              class="btn btn-info">
              ğŸ‘ï¸ Ver Detalles
            </button>
            <button 
              (click)="openTransactionViewer(loan)" 
              class="btn btn-transaction"
              title="Ver transacciones en {{ getNetworkLabel(loan.network) }}">
              ğŸ” Transacciones
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Mensaje cuando no hay prÃ©stamos -->
  <div *ngIf="!isLoading && filteredLoans.length === 0" class="no-loans-message">
    <div class="no-loans-icon">ğŸ“‹</div>
    <h3>No se encontraron prÃ©stamos</h3>
    <p>No hay prÃ©stamos que coincidan con los filtros actuales.</p>
  </div>
  
  <!-- Modal de detalles del prÃ©stamo -->
  <div *ngIf="selectedLoan" class="modal" (click)="closeLoanDetails()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Detalles del PrÃ©stamo #{{ selectedLoan.id | slice:0:8 }}...</h2>
        <button class="close-btn" (click)="closeLoanDetails()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="loan-detail-section">
          <h3>InformaciÃ³n General</h3>
          <div class="detail-row">
            <span class="label">ID:</span>
            <span class="value">{{ selectedLoan.id }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Estado:</span>
            <span class="value status-{{ selectedLoan.status }}">{{ getStatusLabel(selectedLoan.status) }}</span>
          </div>
          <div class="detail-row">
            <span class="label">Fecha de CreaciÃ³n:</span>
            <span class="value">{{ selectedLoan.createdAt | date:'medium' }}</span>
          </div>
          <div class="detail-row" *ngIf="selectedLoan.approvedAt">
            <span class="label">Fecha de AprobaciÃ³n:</span>
            <span class="value">{{ selectedLoan.approvedAt | date:'medium' }}</span>
          </div>
        </div>
        
        <div class="loan-detail-section">
          <h3>InformaciÃ³n del Solicitante</h3>
          <div class="detail-row">
            <span class="label">Nombre:</span>
            <span class="value">{{ selectedLoan.borrowerName }}</span>
          </div>
          <div class="detail-row">
            <span class="label">DirecciÃ³n:</span>
            <span class="value wallet-address">{{ selectedLoan.borrowerAddress }}</span>
          </div>
        </div>
        
        <div class="loan-detail-section">
          <h3>Detalles del PrÃ©stamo</h3>
          <div class="detail-row" style="background: #d1fae5; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
            <span class="label">ğŸ’° Monto que enviarÃ¡ el Admin (completo):</span>
            <span class="value" style="font-weight: bold; color: #059669;">{{ selectedLoan.amount }} ETH</span>
          </div>
          <div class="detail-row">
            <span class="label">ğŸ“Š Tasa de InterÃ©s:</span>
            <span class="value">{{ (selectedLoan.interestRate * 100).toFixed(1) }}%</span>
          </div>
          <div class="detail-row">
            <span class="label">ğŸ’µ InterÃ©s (Ganancia del Admin):</span>
            <span class="value">{{ (selectedLoan.totalAmountToPay - selectedLoan.amount).toFixed(4) }} ETH</span>
          </div>
          <div class="detail-row" style="background: #fee2e2; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
            <span class="label">ğŸ”´ Total que debe devolver el Cliente:</span>
            <span class="value" style="font-weight: bold; color: #dc2626;">{{ selectedLoan.totalAmountToPay.toFixed(4) }} ETH</span>
          </div>
          <div class="detail-row">
            <span class="label">ğŸ¯ PropÃ³sito:</span>
            <span class="value">{{ getPurposeTypeLabel(selectedLoan.purposeType) }}</span>
          </div>
          <div class="detail-row">
            <span class="label">ğŸŒ Red:</span>
            <span class="value">{{ getNetworkLabel(selectedLoan.network) }}</span>
          </div>
          <div class="detail-row">
            <span class="label">â±ï¸ DuraciÃ³n:</span>
            <span class="value">{{ selectedLoan.loanDuration || 'No especificada' }} dÃ­as</span>
          </div>
        </div>
        
        <div class="loan-detail-section" *ngIf="selectedLoan.events">
          <h3>Eventos Importantes</h3>
          <div class="detail-row">
            <span class="value">{{ selectedLoan.events }}</span>
          </div>
        </div>
        
        <div class="loan-detail-section" *ngIf="selectedLoan.contractUrl">
          <h3>Contrato</h3>
          <div class="detail-row">
            <a [href]="selectedLoan.contractUrl" target="_blank" class="btn btn-primary">
              Ver Contrato
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Transaction Viewer Modal -->
<app-transaction-viewer 
  *ngIf="transactionViewerLoan"
  [loan]="transactionViewerLoan"
  [isVisible]="showTransactionViewer"
  (close)="closeTransactionViewer()">
</app-transaction-viewer>